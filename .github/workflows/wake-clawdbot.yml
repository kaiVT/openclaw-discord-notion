name: Wake Codespace and Restart Clawbot Gateway

on:
  schedule:
    # 每 15 分钟跑一次（UTC）
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

jobs:
  wake_and_restart:
    runs-on: ubuntu-latest
    steps:
      - name: Install gh + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Auth GitHub CLI with PAT
        env:
          GH_TOKEN: ${{ secrets.CODESPACES_PAT }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      - name: Start codespace (if stopped)
        env:
          GH_TOKEN: ${{ secrets.CODESPACES_PAT }}
          CODESPACE_NAME: ${{ secrets.CODESPACE_NAME }}
        run: |
          # Start codespace via REST API
          curl -sS -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user/codespaces/${CODESPACE_NAME}/start" \
            | jq .

      - name: Wait until codespace is available
        env:
          GH_TOKEN: ${{ secrets.CODESPACES_PAT }}
          CODESPACE_NAME: ${{ secrets.CODESPACE_NAME }}
        run: |
          set -e
          for i in {1..30}; do
            state=$(curl -sS -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/user/codespaces/${CODESPACE_NAME}" | jq -r '.state')
            echo "codespace state = ${state}"
            if [ "${state}" = "Available" ]; then
              exit 0
            fi
            sleep 10
          done
          echo "Codespace not ready in time" >&2
          exit 1

      - name: Restart gateway inside codespace
        env:
          CODESPACE_NAME: ${{ secrets.CODESPACE_NAME }}
        run: |
          # 用 gh codespace ssh 在 codespace 内执行命令
          # 先尝试 restart；失败再 start；最后看一下 status
          gh codespace ssh -c "${CODESPACE_NAME}" -- bash -lc '
            set -e
            command -v openclaw >/dev/null 2>&1 || { echo "openclaw not found"; exit 1; }
            openclaw gateway restart || openclaw gateway start
            openclaw gateway status --json || true
          '
