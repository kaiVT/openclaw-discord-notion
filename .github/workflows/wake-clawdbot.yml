name: Wake Codespace and Restart Clawbot Gateway

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

jobs:
  wake_and_restart:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.CODESPACES_PAT }}
      CODESPACE_NAME: ${{ secrets.CODESPACE_NAME }}

    steps:
      - name: Sanity check gh + token
        run: |
          gh --version
          gh auth status -h github.com || true

      - name: Start codespace (if stopped)
        run: |
          # This endpoint requires codespace permission on the token
          gh api -X POST "/user/codespaces/${CODESPACE_NAME}/start" --silent
          echo "Start request sent."

      - name: Wait until codespace is available
        shell: bash
        run: |
          set -e
          for i in {1..30}; do
            state=$(gh api "/user/codespaces/${CODESPACE_NAME}" --jq '.state')
            echo "codespace state = ${state}"
            if [ "${state}" = "Available" ]; then
              exit 0
            fi
            sleep 10
          done
          echo "Codespace not ready in time" >&2
          exit 1

      - name: Restart gateway inside codespace
        run: |
          gh codespace ssh -c "${CODESPACE_NAME}" -- bash -lc '
            set -e
            command -v openclaw >/dev/null 2>&1 || { echo "openclaw not found"; exit 1; }
            openclaw gateway restart || openclaw gateway start
            openclaw gateway status --json || true
          '
